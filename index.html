<!doctype html>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f9;
        text-align: center;
        padding: 20px;
        color: #333;
    }

    /* Incoming Call Popup Styles */
    #incomingCall {
        display: none;
        z-index: 999999;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        width: 250px;
        height: 40px;
        line-height: 40px;
        border-radius: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        text-align: center;
        overflow: hidden;
        color: #fff;
        font-size: 14px;
    }

    #incomingCall p {
        display: inline;
        margin-right: 10px;
        font-size: 12px;
    }

    .call-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 20px;
        margin: 0 5px;
        transition: transform 0.2s;
    }

    .call-btn:active {
        transform: scale(0.9);
    }

    .call-btn.accept {
        color: #4CAF50;
    }

    .call-btn.reject {
        color: #F44336;
    }

    /* Call Timer */
    #callTimer {
        display: inline;
        font-size: 16px;
        margin-left: 10px;
        color: #ffeb3b;
    }

    #callUser {
        background: #2196F3;
        color: #fff;
    }

    #callUser:disabled {
        background: #b3e5fc;
        cursor: not-allowed;
    }

    #endCall {
        background: #FF9800;
        color: #fff;
        display: none;
    }
</style>

<h2>WebRTC Audio Call System</h2>
<button id="callUser" disabled>Call</button>
<button id="endCall" style="display:none;">End Call</button>

<div id="incomingCall">
    <p>Incoming Call...</p>
    <button id="acceptCall" class="call-btn accept-btn">Accept</button>
    <button id="rejectCall" class="call-btn reject-btn">Reject</button>
</div>

<h3>Call Status: <span id="callStatus">Not Connected</span></h3>
<h3>Call Time: <span id="callTimer">00:00</span></h3>

<!-- Ringtone Audio -->
<audio id="ringtone" loop>
    <source src="https://github.com/Vivekmasona/vfy-fm/raw/refs/heads/main/sound/ms.mp3" type="audio/mp3">
</audio>

<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<script>
    const socket = io("https://vfycall.onrender.com/");
    let localStream;
    let peerConnection;
    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let roomID;

    const ringtone = document.getElementById('ringtone');

    // Automatically join room if sessionId is found in localStorage
    window.addEventListener('load', () => {
        roomID = localStorage.getItem('sessionId');
        if (roomID) {
            socket.emit('join-room', roomID);
            document.getElementById('callUser').disabled = false;
            alert(`Automatically Joined Room: ${roomID}`);
        } else {
            alert('Session ID not found. Please check if it is saved correctly.');
        }
    });

    // Call User
    document.getElementById('callUser').addEventListener('click', () => {
        socket.emit('call-request', { roomID });
        document.getElementById('callStatus').innerText = 'Calling...';
    });

    // Incoming Call Popup
    socket.on('incoming-call', ({ from }) => {
        document.getElementById('incomingCall').style.display = 'block';
        ringtone.play(); // Play ringtone

        document.getElementById('acceptCall').onclick = async () => {
            document.getElementById('incomingCall').style.display = 'none';
            ringtone.pause(); // Stop ringtone
            ringtone.currentTime = 0;
            socket.emit('call-accepted', { to: from });
        };

        document.getElementById('rejectCall').onclick = () => {
            socket.emit('call-rejected', { to: from });
            document.getElementById('incomingCall').style.display = 'none';
            document.getElementById('callStatus').innerText = 'Call Rejected';
            ringtone.pause(); // Stop ringtone
            ringtone.currentTime = 0;
        };
    });

    // Call Accepted
    socket.on('call-accepted', async () => {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        peerConnection = new RTCPeerConnection(config);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = (event) => {
            const remoteAudio = new Audio();
            remoteAudio.srcObject = event.streams[0];
            remoteAudio.play();
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('candidate', { candidate: event.candidate, roomID });
            }
        };

        document.getElementById('callStatus').innerText = 'Connected';
        document.getElementById('endCall').style.display = 'inline';
        ringtone.pause(); // Stop ringtone
        ringtone.currentTime = 0;
    });

    // End Call
    document.getElementById('endCall').addEventListener('click', () => {
        socket.emit('end-call', roomID);
        endCall();
    });

    socket.on('call-ended', () => {
        endCall();
    });

    function endCall() {
        if (peerConnection) peerConnection.close();
        peerConnection = null;
        document.getElementById('callStatus').innerText = 'Call Ended';
        document.getElementById('endCall').style.display = 'none';
        ringtone.pause(); // Stop ringtone
        ringtone.currentTime = 0;
    }
</script>
