

<style>body {
    font-family: Arial, sans-serif;
    background: #f4f4f9;
    text-align: center;
    padding: 20px;
    color: #333;
}

/* Incoming Call Popup Styles */
#incomingCall {
    display: none;
    z-index: 999999;
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    width: auto;
    min-width: 250px;
    height: 50px;
    line-height: 50px;
    border-radius: 25px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    text-align: center;
    overflow: hidden;
    color: #fff;
    font-size: 14px;
    padding: 0 15px;
}

#incomingCall p {
    display: inline-block;
    margin-right: 10px;
    font-size: 14px;
}

.call-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 20px;
    margin: 0 5px;
    transition: transform 0.2s;
}

.call-btn:active {
    transform: scale(0.9);
}

.call-btn.accept {
    color: #4CAF50;
}

.call-btn.reject {
    color: #F44336;
}

.call-btn.end {
    color: #FF9800;
    display: none;
}

/* Call Timer */
#callTimer {
    display: none;
    font-size: 16px;
    margin-left: 10px;
    color: #ffeb3b;
}</style>

<div id="incomingCall">
    <p>Incoming Call...</p>
    <span id="callTimer">00:00</span>
    <button class="call-btn accept" id="acceptCall">
        <i class="fas fa-phone"></i>
    </button>
    <button class="call-btn reject" id="rejectCall">
        <i class="fas fa-phone-slash"></i>
    </button>
    <button class="call-btn end" id="endCall">
        <i class="fas fa-phone-slash"></i>
    </button>
</div>
<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
   
<script>const socket = io("https://vfycall.onrender.com/");

let localStream;
let peerConnection;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
let roomID;
let callTimer;
let callStartTime;

// Ringtone for Incoming Call
const ringtone = new Audio("https://github.com/Vivekmasona/vfy-fm/raw/refs/heads/main/sound/ms.mp3");
ringtone.loop = true;

// Get Popup Elements
const incomingCallPopup = document.getElementById('incomingCall');
const callTimerElement = document.getElementById('callTimer');
const acceptCallButton = document.getElementById('acceptCall');
const rejectCallButton = document.getElementById('rejectCall');
const endCallButton = document.getElementById('endCall');

// Automatically join room if sessionId is found in localStorage
window.addEventListener('load', () => {
    roomID = localStorage.getItem('sessionId');
    if (roomID) {
        socket.emit('join-room', roomID);
        document.getElementById('callUser').disabled = false;
        alert(`Automatically Joined Room: ${roomID}`);
    } else {
        alert('Session ID not found. Please check if it is saved correctly.');
    }
});

// Call User
document.getElementById('callUser').addEventListener('click', async () => {
    socket.emit('call-request', { roomID });
    document.getElementById('callStatus').innerText = 'Calling...';
});

// Incoming Call Popup
socket.on('incoming-call', ({ from }) => {
    incomingCallPopup.style.display = 'block';
    callTimerElement.style.display = 'none';
    acceptCallButton.style.display = 'inline';
    rejectCallButton.style.display = 'inline';
    endCallButton.style.display = 'none';
    ringtone.play();
    document.getElementById('callStatus').innerText = 'Incoming Call...';

    // Accept Call
    acceptCallButton.onclick = async () => {
        ringtone.pause();
        ringtone.currentTime = 0;
        socket.emit('call-accepted', { to: from });
        incomingCallPopup.style.display = 'none';
        document.getElementById('callStatus').innerText = 'Connecting...';

        // Initialize Media
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        peerConnection = new RTCPeerConnection(config);
        peerConnection.addTrack(localStream.getTracks()[0], localStream);

        peerConnection.ontrack = (event) => {
            const remoteAudio = new Audio();
            remoteAudio.srcObject = event.streams[0];
            remoteAudio.play();
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('candidate', { candidate: event.candidate, roomID });
            }
        };

        document.getElementById('callStatus').innerText = 'Connected';
        endCallButton.style.display = 'inline';
        callTimerElement.style.display = 'inline';
        startCallTimer();
    };

    // Reject Call
    rejectCallButton.onclick = () => {
        ringtone.pause();
        ringtone.currentTime = 0;
        socket.emit('call-rejected', { to: from });
        incomingCallPopup.style.display = 'none';
        document.getElementById('callStatus').innerText = 'Call Rejected';
    };
});

// Call Accepted
socket.on('call-accepted', async () => {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    peerConnection = new RTCPeerConnection(config);
    peerConnection.addTrack(localStream.getTracks()[0], localStream);

    peerConnection.ontrack = (event) => {
        const remoteAudio = new Audio();
        remoteAudio.srcObject = event.streams[0];
        remoteAudio.play();
    };

    peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            socket.emit('candidate', { candidate: event.candidate, roomID });
        }
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('offer', { offer, roomID });

    document.getElementById('callStatus').innerText = 'Connected';
    endCallButton.style.display = 'inline';
    callTimerElement.style.display = 'inline';
    startCallTimer();
});

// Handle Offer
socket.on('offer', async ({ offer }) => {
    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('answer', { answer, roomID });
});

// Handle Answer
socket.on('answer', async ({ answer }) => {
    await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
});

// Handle ICE Candidate
socket.on('candidate', ({ candidate }) => {
    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
});

// End Call
endCallButton.addEventListener('click', () => {
    socket.emit('end-call', roomID);
    endCall();
});

socket.on('call-ended', () => {
    endCall();
});

function endCall() {
    if (peerConnection) peerConnection.close();
    peerConnection = null;
    document.getElementById('callStatus').innerText = 'Call Ended';
    endCallButton.style.display = 'none';
    incomingCallPopup.style.display = 'none';
    stopCallTimer();
}

// Call Timer Functions
function startCallTimer() {
    callStartTime = new Date();
    callTimer = setInterval(() => {
        const now = new Date();
        const elapsed = Math.floor((now - callStartTime) / 1000);
        const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const seconds = String(elapsed % 60).padStart(2, '0');
        callTimerElement.innerText = `${minutes}:${seconds}`;
    }, 1000);
}

function stopCallTimer() {
    clearInterval(callTimer);
    callTimerElement.innerText = '00:00';
}</script>
